<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Malwarebytes 2017 CrackMe Stage 2 | Morgen's Blog </title> <meta name="author" content=" "> <meta name="description" content="Writeup for the second half of Malwarebytes's 2017 CrackMe challenge."> <meta name="keywords" content="malware, malware-analysism, reversing, reverse-engineering, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.ico?92f83e0a87e85acaf5c47d635ea72e23"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://morgenm.github.io/blog/2023/malwarebytes-2017-crackme-stage-2/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Morgen's Blog </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/portfolio/">portfolio </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Malwarebytes 2017 CrackMe Stage 2</h1> <p class="post-meta"> Created on February 08, 2023 </p> <p class="post-tags"> <a href="/blog/2023"> <i class="fa-solid fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/ctf"> <i class="fa-solid fa-hashtag fa-sm"></i> ctf</a>   <a href="/blog/tag/reverse-engineering"> <i class="fa-solid fa-hashtag fa-sm"></i> reverse-engineering</a>   <a href="/blog/tag/malwarebytes-crackme"> <i class="fa-solid fa-hashtag fa-sm"></i> malwarebytes-crackme</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>I left my last post off by mentioning that stage 1 of the Malwarebytes 2017 CrackMe performs process replacement/hollowing in order to execute stage 2. In this post I will finish discussing the CrackMe by investigating stage 2, and ultimately discovering the flag. If you have not already read my previous post, you can find it <a href="/blog/2023/malwarebytes-2017-crackme-stage-1/">here</a>.</p> <p>I began by opening the stage 2 executable, which was dumped and decoded in the last post, in Ghidra. Perusing through the decompiled code, a call to ExpandEnvironmentStringsA with the same parameters as the code in stage 1 can be seen. Furthermore, there is a call to GetModuleFileNameA as well as code which performs xor operations on an input string. Some basic sleuthing reveals that the xor_leet function shown below will calculate a single value based on input data. This seems to me to be some sort of checksum function. With that in mind, it becomes clear that the code is comparing the process’s path to its expected value, which, based on how stage 1 loads stage 2, should include rundll32.exe.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/malwarebytes-crackme-1-stage2/environment_strings-480.webp 480w,/assets/img/malwarebytes-crackme-1-stage2/environment_strings-800.webp 800w,/assets/img/malwarebytes-crackme-1-stage2/environment_strings-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/malwarebytes-crackme-1-stage2/environment_strings.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Next, I loaded the program in x32dbg on my Windows VM while also reversing it in Ghidra. To get around the environment strings comparison mentioned above, I simply patched the file in the debugger, just as I did in stage 1 time and time again.</p> <p>I continued examining the listing in Ghidra. After the first comparison successfully executes, the program calls EnumWindows. Upon consulting Windows documentation for this API call, I learned that it is enumerating all open windows on the screen and passing the window handles to a callback function. This callback function is defined by the “malware” author, and compares the checksum of each window name with that of a hardcoded checksum value. It is looking for a specific process, but I do not know which one. In the end, it doesn’t matter what process it is looking for, which will become evident later.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/malwarebytes-crackme-1-stage2/callback-480.webp 480w,/assets/img/malwarebytes-crackme-1-stage2/callback-800.webp 800w,/assets/img/malwarebytes-crackme-1-stage2/callback-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/malwarebytes-crackme-1-stage2/callback.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Deeper within the main function, there is a call to CreateRemoteThread, as well as RtlCreateUserThread and a function call which in turn calls ZwCreateThreadEx. As a fun little aside, global function pointers are setup in stage 2 to point to RtlCreateUserThread and ZwCreateThreadEx, as well as a few other Windows API calls, to hide what the imports are. Anyways, those function calls indicate that there may be some more process injection occurring. The code decides which of those three API calls to perform, based on some tick count.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/malwarebytes-crackme-1-stage2/global_fps-480.webp 480w,/assets/img/malwarebytes-crackme-1-stage2/global_fps-800.webp 800w,/assets/img/malwarebytes-crackme-1-stage2/global_fps-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/malwarebytes-crackme-1-stage2/global_fps.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Regardless of which method is used to create a thread, I need to find out what process is being run. The lpStartAddress which is used when creating the thread is determined by a function which creates and maps a section so it can copy data from the current process to the injected process. Following the trail indicates the data being copied is global data. This data should be the shellcode. But, before I can dump the shellcode in x32dbg, there is one bit of code that needs attention. The CrackMe xors the shellcode before it is injected. The xor key is determined by what value is stored in PEB[2]. Looking at the <a href="https://learn.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb" rel="external nofollow noopener" target="_blank">Windows documentation</a> for the Process Environment Block, PEB[2] would be BeingDebugged. Originally, I thought this was an antidebugging check and that PEB[2] should be zero (which it was while running x32dbg). So, I continued by dumping the shellcode from memory to a file. I dumped 0x177 bytes since memcpy and some other functions took that in as the length of the buffer storing the shellcode.</p> <p>I had to do some research to learn how to debug shellcode. I eventually stumbled upon shellcode2exe. The Python version of the script did not work for me, so I used the portable package found <a href="https://github.com/fr0gger/shellcode2exe_package" rel="external nofollow noopener" target="_blank">here</a>. I used the program to generate an exectuable from the shellcode I dumped to a file. I tried running the program created from the shellcode, but nothing really happened beyond x32dbg freezing. I thought that maybe it was a problem with shellcode2exe, so I resolved to force stage 2 to inject into notepad.exe. I did this by creating a conditional breakpoint within the code which compares the window names, forcing it to break when it finds “Notepad” in the EnumWindows callback. I then forced the program to accept Notepad as the process it was searching for by manipulating EIP to execute the if-statement body. This actually worked, except it didn’t. It injected the code, allowing me to attach to notepad.exe in another debugger instance, but it was again seemingly invalid shellcode which prevented the program from doing anything.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/malwarebytes-crackme-1-stage2/conditional_breakpoint-480.webp 480w,/assets/img/malwarebytes-crackme-1-stage2/conditional_breakpoint-800.webp 800w,/assets/img/malwarebytes-crackme-1-stage2/conditional_breakpoint-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/malwarebytes-crackme-1-stage2/conditional_breakpoint.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/malwarebytes-crackme-1-stage2/notepad_process-480.webp 480w,/assets/img/malwarebytes-crackme-1-stage2/notepad_process-800.webp 800w,/assets/img/malwarebytes-crackme-1-stage2/notepad_process-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/malwarebytes-crackme-1-stage2/notepad_process.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Since my previous attempts failed, I decided to look at the code which xors the shellcode again. On a whim, after PEB[2], or BeingDebugged, is loaded into eax, I changed the value from 0 to 1. There is one part of stage 2 which I have failed to mention until this point. The program performs a checksum on the shellcode and compares it against a hardcoded value. I unwisely ignored this until now. Previously, when PEB[2] was 0, the checksum always failed. But now, when I set it to 1, the checksum passed! I guessed that this meant that the xor was successful, and that I can grab the real shellcode. I dumped it again and passed it through shellcode2exe.</p> <p>I opened the new executable and ran it. It just gave me the flag!</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/malwarebytes-crackme-1-stage2/flag-480.webp 480w,/assets/img/malwarebytes-crackme-1-stage2/flag-800.webp 800w,/assets/img/malwarebytes-crackme-1-stage2/flag-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/malwarebytes-crackme-1-stage2/flag.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Overall this was a pretty fun CrackMe challenge. The challenge used some basic process injection techniques, as well as a couple of antidebugging tricks I was unaware of, so it was a nice chance to learn and practice. I am planning on doing some of the other Malwarebytes CrackMes soon, as well as some other malware analysis and reverse engineering challenges. For now though I am planning on taking a break and diving into something unrelated in my next post.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/basicgopot-hybrid-analysis/">Using basicgopot with Hybrid-Analysis</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/phishing-detection-ai/">Detecting Phishing Emails with NLP and AI</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/malwarebytes-2017-crackme-stage-1/">Malwarebytes 2017 CrackMe Stage 1</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 . Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>